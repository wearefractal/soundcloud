// Generated by CoffeeScript 1.6.1
var apiKey, cookie, getParam, request, soundcloud, tok;

cookie = require('cookie');

request = require('superagent');

apiKey = null;

getParam = function(param) {
  var match, re, url;
  url = window.location.hash;
  re = new RegExp("#" + param + "=([^&]+)(&|$)");
  match = url.match(re);
  if (!((match != null) && (match[1] != null))) {
    return;
  }
  return match[1];
};

soundcloud = {
  base: "https://api.soundcloud.com",
  cookieName: "soundcloud_access_token",
  setKey: function(key) {
    return apiKey = key;
  },
  token: function() {
    return cookie(soundcloud.cookieName);
  },
  clearToken: function() {
    cookie(soundcloud.cookieName, null);
    return soundcloud;
  },
  setToken: function(val) {
    cookie(soundcloud.cookieName, val, {
      maxage: 604800000,
      path: '/'
    });
    return soundcloud;
  },
  authorize: function(cburl) {
    var uri;
    if (cburl == null) {
      cburl = window.location.origin;
    }
    uri = "" + soundcloud.base + "/connect/?response_type=token&scope=non-expiring&client_id=" + apiKey + "&redirect_uri=" + cburl;
    window.location.href = uri;
    return soundcloud;
  },
  makeRequest: function(path, opt, type, cb) {
    var req, uri;
    if (opt == null) {
      opt = {};
    }
    if (typeof opt === 'function' && !cb) {
      cb = opt;
      opt = {};
    }
    uri = "" + soundcloud.base + path;
    req = request[type](uri);
    if (opt.headers) {
      req.set(opt.headers);
    }
    if (opt.qs) {
      req.query(opt.qs);
    }
    if (soundcloud.token()) {
      req.query({
        oauth_token: soundcloud.token()
      });
    } else {
      req.query({
        client_id: apiKey
      });
    }
    req.query({
      "_status_code_map[302]": 200,
      format: "json"
    });
    if (opt.data) {
      req.send(opt.data);
    }
    req.end(cb);
    return req;
  },
  get: function(path, opt, cb) {
    return soundcloud.makeRequest(path, opt, 'get', cb);
  },
  post: function(path, opt, cb) {
    return soundcloud.makeRequest(path, opt, 'post', cb);
  },
  put: function(path, opt, cb) {
    return soundcloud.makeRequest(path, opt, 'put', cb);
  },
  del: function(path, opt, cb) {
    return soundcloud.makeRequest(path, opt, 'del', cb);
  }
};

tok = getParam("access_token");

if (tok != null) {
  soundcloud.setToken(tok);
}

module.exports = soundcloud;
